name: Bruno CI/CD ‚Äì Tests + D√©ploiement Render

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 1. Collection 1 (Get + Post) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  collection-1:
    runs-on: ubuntu-latest
    name: CI - Collection 1 ‚Äì Get + Post
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @usebruno/cli
      - name: Run Collection 1
        run: |
          bru run "bruno/collection_1/Get_Request" "bruno/collection_1/PostRequest" \
            --env-file environments/ci.bru \
            --format html \
            --output report-collection-1.html
      - uses: actions/upload-artifact@v4
        with:
          name: report-collection-1
          path: report-collection-1.html

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 2. Collection 2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  collection-2:
    runs-on: ubuntu-latest
    name: CI - Collection 2 ‚Äì ReqRes + GoRest + JSONPH
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g @usebruno/cli
      - name: Run Collection 2
        run: |
          bru run "bruno/collection_2" \
            --env-file environments/ci.bru \
            --format html \
            --output report-collection-2.html || echo "GoRest 403 ignor√©"
      - uses: actions/upload-artifact@v4
        with:
          name: report-collection-2
          path: report-collection-2.html

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 3. CD ‚Äì D√©ploiement Render (FIXED - No if conditions on secrets) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy-render:
    needs: [collection-1, collection-2]
    runs-on: ubuntu-latest
    name: CD - D√©ploiement Auto ‚Üí Render
    if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
    steps:
      - name: D√©clenche le d√©ploiement sur Render
        continue-on-error: true
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$DEPLOY_HOOK" ]; then
            echo "‚ö†Ô∏è  Aucun secret RENDER_DEPLOY_HOOK configur√©"
            echo "Pour activer le CD : ajoute le secret dans Settings > Secrets > Actions"
            echo "Le d√©ploiement est ignor√© pour cette ex√©cution."
            exit 0
          fi
          
          echo "üöÄ D√©ploiement automatique de l'API en cours..."
          echo "URL : https://bfg-api-blood-demand-gl.onrender.com"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "$DEPLOY_HOOK" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": true}' || echo "curl_failed")
          
          if [[ "$RESPONSE" == "2"* ]] || [[ "$RESPONSE" == "3"* ]]; then
            echo "‚úÖ D√©ploiement d√©clench√© avec succ√®s ! (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è  Attention : R√©ponse inattendue du webhook Render (HTTP $RESPONSE)"
            exit 1
          fi